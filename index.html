<!doctype html>
<html lang="es">
<head>
  
  <meta name="apple-mobile-web-app-capable" content="yes">
  <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">

  <link rel="apple-touch-icon" sizes="180x180" href="apple-touch-icon.png">
  <link rel="icon" type="image/png" sizes="32x32" href="favicon-32x32.png">
  <link rel="icon" type="image/png" sizes="16x16" href="favicon-16x16.png">

  <link rel="manifest" href="manifest.webmanifest">

  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Cotizador Corte L√°ser</title>
  <style>
    body { font-family: -apple-system, system-ui, Arial; margin: 14px; }
    h1 { font-size: 18px; margin: 0 0 10px; }
    .card { border: 1px solid #ddd; border-radius: 12px; padding: 10px; margin-bottom: 10px; }
    label { display:block; font-size: 11px; opacity:.8; margin-top: 8px; }
    input, select, textarea { width: 100%; padding: 8px; border: 1px solid #ccc; border-radius: 10px; font-size: 14px; background:#fff; }
    textarea { min-height: 54px; resize: vertical; }
    .row { display:flex; gap:8px; }
    .row > div { flex:1; }
    button { width:100%; padding: 10px; font-size: 15px; border:0; border-radius: 12px; cursor:pointer; }
    .primary { background:#111; color:#fff; }
    .ghost { background:#f2f2f2; }
    .danger { background:#ffe8e8; }
    .out { font-size: 15px; line-height: 1.35; }
    .big { font-size: 20px; font-weight: 700; }
    .muted { opacity: .75; font-size: 12px; }
    .hr { height:1px; background:#eee; margin:10px 0; }
    .ok { font-size: 12px; opacity:.75; margin-top:8px; }
    .twoBtns { display:flex; gap:8px; margin-top:10px; }
    .twoBtns button { flex:1; }
    .historyRow { display:flex; gap:8px; align-items:flex-start; padding:10px; border:1px solid #eee; border-radius:12px; margin-top:10px; }
    .historyMain { flex:1; }
    .pill { display:inline-block; font-size:12px; padding:4px 8px; border-radius:999px; background:#f2f2f2; margin-right:6px; margin-top:6px; }
    .smallBtns { display:flex; flex-direction:column; gap:8px; width:110px; }
    .smallBtns button { padding:10px; font-size:14px; }
    .printOnly { display:none; }

    /* üîí Estilo de campo bloqueado */
    input[readonly].locked {
      background: #f6f6f6;
      color: #444;
      border-color: #e0e0e0;
    }

    @media print {
      body { margin: 0; }
      .noPrint { display:none !important; }
      .printOnly { display:block; }
      .card { border: none; }
      .historyRow { border: none; }
    }
  </style>
</head>
<body>

  <h1 class="noPrint">üìê Cotizador Corte L√°ser (acero)</h1>

  <div class="card noPrint">
    <div class="row">
      <div>
        <label>Largo (in)</label>
        <input id="L" type="number" inputmode="decimal" value="6" step="0.01" />
      </div>
      <div>
        <label>Ancho (in)</label>
        <input id="W" type="number" inputmode="decimal" value="3" step="0.01" />
      </div>
    </div>

    <div class="row">
      <div>
        <label>Espesor (in)</label>
        <input id="T" type="number" inputmode="decimal" value="0.0625" step="0.0001" />
      </div>
      <div>
        <label>Cantidad</label>
        <input id="qty" type="number" inputmode="numeric" value="1" min="1" step="1" />
      </div>
    </div>

    <div class="row">
      <div>
        <label>Modo de tiempo</label>
        <select id="timeMode" onchange="calc()">
          <option value="per_piece" selected>Por pieza</option>
          <option value="total_job">Total lote</option>
        </select>
      </div>
      <div>
        <label>Tiempo (min)</label>
        <input id="cutMin" type="number" inputmode="decimal" value="15" step="0.1" />
      </div>
      <div>
        <label>Tiempo (seg)</label>
        <input id="cutSec" type="number" inputmode="numeric" value="0" min="0" step="1" />
      </div>
    </div>

    <div class="row">
      <div>
        <label>Calibre (acero) 6‚Äì20</label>
        <select id="gaugeSelect" onchange="applyGauge()"></select>
      </div>
      <div>
        <label>Espesor r√°pido (1&quot; ‚Üí 1/16&quot;)</label>
        <select id="fracSelect" onchange="applyFraction()"></select>
      </div>
    </div>

    <div class="hr"></div>

    <div class="row">
      <div>
        <label>Factor fijo (in¬≥ ‚Üí kg)</label>
        <!-- üîí BLOQUEADO -->
        <input id="factorDisplay" class="locked" type="text" value="0.13 (in¬≥ ‚Üí kg)" readonly />
      </div>
      <div>
        <label>USD/kg (1.7)</label>
        <input id="usdKg" type="number" inputmode="decimal" value="1.7" step="0.01" />
      </div>
    </div>

    <div class="row">
      <div>
        <label>USD/h l√°ser (85)</label>
        <input id="usdHr" type="number" inputmode="decimal" value="85" step="1" />
      </div>
      <div>
        <label>Setup (por lote)</label>
        <input id="setup" type="number" inputmode="decimal" value="0" step="1" />
      </div>
    </div>

    <div class="row">
      <div>
        <label>Merma %</label>
        <input id="wastePct" type="number" inputmode="decimal" value="0" step="1" />
      </div>
      <div>
        <label>Margen % (ganancia)</label>
        <input id="marginPct" type="number" inputmode="decimal" value="0" step="1" />
      </div>
    </div>

    <label>Notas (opcional)</label>
    <textarea id="notes" placeholder="Ej: Incluye desbarbado / entrega / material proporcionado por cliente, etc."></textarea>

    <div class="twoBtns">
      <button class="primary" onclick="calc()">Calcular</button>
      <button class="ghost" onclick="resetDefaults()">Reset</button>
    </div>
  </div>

  <div class="card">
    <div class="printOnly" style="margin-bottom:10px;">
      <div style="font-size:18px;font-weight:700;">Cotizaci√≥n Corte L√°ser</div>
      <div class="muted" id="printDate"></div>
      <div class="hr"></div>
    </div>

    <div class="out" id="out">Ingresa datos y presiona <b>Calcular</b>.</div>

    <div class="twoBtns noPrint">
      <button class="primary" onclick="copyWhatsApp()">üì≤ Copiar WhatsApp</button>
      <button class="ghost" onclick="shareWhatsApp()">üí¨ Abrir WhatsApp</button>
    </div>

    <div class="twoBtns noPrint">
      <button class="primary" onclick="saveToHistory()">üíæ Guardar historial</button>
      <button class="ghost" onclick="printPDF()">üßæ PDF</button>
    </div>

    <div class="ok noPrint" id="copyStatus"></div>

    <div class="muted noPrint" style="margin-top:10px">
      Setup por lote. Merma afecta material. Margen aplica al total.
    </div>
  </div>

  <div class="card noPrint">
    <div style="display:flex; justify-content:space-between; align-items:center; gap:10px;">
      <div>
        <div style="font-weight:700;">üìö Historial</div>
        <div class="muted">Se guarda en tu celular (localStorage). Puedes cargar una cotizaci√≥n vieja y volver a editar.</div>
      </div>
      <button class="danger" style="max-width:180px;" onclick="clearHistory()">Borrar</button>
    </div>

    <div id="history"></div>
  </div>

<script>
  const HISTORY_KEY = "laser_quote_history_v1";

  // üîí FACTOR OFICIAL FIJO (in¬≥ ‚Üí kg)
  const FACTOR_IN3_TO_KG = 0.13;

  const STEEL_GAUGE_IN = {
    6: 0.1943, 7: 0.1793, 8: 0.1644, 9: 0.1495,
    10: 0.1345, 11: 0.1196, 12: 0.1046, 13: 0.0897,
    14: 0.0747, 15: 0.0673, 16: 0.0598, 17: 0.0538,
    18: 0.0478, 19: 0.0418, 20: 0.0359
  };

  const FRACTIONS = [
    { label: '1"', val: 1.0 },
    { label: '3/4"', val: 0.75 },
    { label: '1/2"', val: 0.5 },
    { label: '3/8"', val: 0.375 },
    { label: '1/4"', val: 0.25 },
    { label: '3/16"', val: 0.1875 },
    { label: '1/8"', val: 0.125 },
    { label: '3/32"', val: 0.09375 },
    { label: '1/16"', val: 0.0625 }
  ];

  function money(x){
    if (!isFinite(x)) return "$0.00";
    return "$" + (Math.round(x*100)/100).toFixed(2);
  }

  function clampQty(q){
    if (!isFinite(q) || q < 1) return 1;
    return Math.floor(q);
  }

  function nowStamp(){ return new Date().toISOString(); }

  function niceDate(iso){
    try{ return new Date(iso).toLocaleString(); } catch { return iso; }
  }

  function initLists(){
    const g = document.getElementById("gaugeSelect");
    g.innerHTML = `<option value="">(calibre)</option>`;
    Object.keys(STEEL_GAUGE_IN).map(Number).sort((a,b)=>a-b).forEach(ga=>{
      const t = STEEL_GAUGE_IN[ga];
      g.innerHTML += `<option value="${ga}">${ga} ga ‚Üí ${t.toFixed(4)}"</option>`;
    });

    const f = document.getElementById("fracSelect");
    f.innerHTML = `<option value="">(espesor)</option>`;
    FRACTIONS.forEach(fr=>{
      f.innerHTML += `<option value="${fr.val}">${fr.label} ‚Üí ${fr.val}</option>`;
    });

    // Mostrar el factor fijo en pantalla (por si cambias la constante en el futuro)
    document.getElementById("factorDisplay").value = `${FACTOR_IN3_TO_KG} (in¬≥ ‚Üí kg)`;
  }

  function applyGauge(){
    const ga = parseInt(document.getElementById("gaugeSelect").value, 10);
    if (!isNaN(ga) && STEEL_GAUGE_IN[ga]){
      document.getElementById("T").value = STEEL_GAUGE_IN[ga];
      document.getElementById("fracSelect").value = "";
      calc();
    }
  }

  function applyFraction(){
    const v = parseFloat(document.getElementById("fracSelect").value);
    if (!isNaN(v) && v > 0){
      document.getElementById("T").value = v;
      document.getElementById("gaugeSelect").value = "";
      calc();
    }
  }

  let LAST = null;

  function calc(){
    const L = parseFloat(document.getElementById("L").value || 0);
    const W = parseFloat(document.getElementById("W").value || 0);
    const T = parseFloat(document.getElementById("T").value || 0);

    const qty = clampQty(parseFloat(document.getElementById("qty").value || 1));
    document.getElementById("qty").value = qty;

    const timeMode = document.getElementById("timeMode").value;

    const cutMinInput = parseFloat(document.getElementById("cutMin").value || 0);
    const cutSecInputRaw = parseFloat(document.getElementById("cutSec").value || 0);
    const cutSecInput = Math.max(0, Math.floor(isFinite(cutSecInputRaw) ? cutSecInputRaw : 0));
    document.getElementById("cutSec").value = cutSecInput;

    const cutTotalMinInput = cutMinInput + (cutSecInput / 60.0);

    const usdKg = parseFloat(document.getElementById("usdKg").value || 0);
    const usdHr = parseFloat(document.getElementById("usdHr").value || 0);

    const setup = parseFloat(document.getElementById("setup").value || 0);
    const wastePct = (parseFloat(document.getElementById("wastePct").value || 0) / 100.0);
    const marginPct = (parseFloat(document.getElementById("marginPct").value || 0) / 100.0);

    const notes = (document.getElementById("notes").value || "").trim();

    // ‚úÖ Volumen en pulgadas c√∫bicas (in¬≥), sin conversi√≥n
    const volumeIn3_piece = L * W * T;

    // ‚úÖ Peso en kg usando factor fijo oficial
    const weightKg_piece = volumeIn3_piece * FACTOR_IN3_TO_KG;

    let material_piece = weightKg_piece * usdKg;
    material_piece *= (1 + wastePct);

    const material_total = material_piece * qty;

    const cutMin_total = (timeMode === "per_piece") ? (cutTotalMinInput * qty) : cutTotalMinInput;
    const laser_total = (cutMin_total / 60.0) * usdHr;

    const base_total = material_total + laser_total + setup;
    const total = base_total * (1 + marginPct);
    const per_piece = total / qty;

    LAST = {
      ts: nowStamp(),
      inputs: { L, W, T, qty, timeMode, cutMinInput, cutSecInput, usdKg, usdHr, setup, wastePct, marginPct, notes },
      calc: { volumeIn3_piece, weightKg_piece, material_piece, material_total, cutMin_total, laser_total, base_total, total, per_piece }
    };

    document.getElementById("printDate").textContent = "Fecha: " + new Date().toLocaleString();

    const tm = (timeMode === "per_piece")
      ? `Tiempo por pieza: ${cutMinInput} min ${cutSecInput} seg`
      : `Tiempo total del lote: ${cutMinInput} min ${cutSecInput} seg`;

    document.getElementById("out").innerHTML = `
      <div class="big">Total: ${money(total)} <span class="muted">( ${money(per_piece)} c/u )</span></div>
      <div class="hr"></div>

      <div><b>Cantidad:</b> ${qty}</div>
      <div><b>Dimensiones:</b> ${L}" √ó ${W}" √ó ${T}"</div>
      <div><b>${tm}</b></div>
      <div><b>Tiempo total:</b> ${cutMin_total.toFixed(2)} min</div>

      <div class="hr"></div>

      <div><b>Volumen (por pieza):</b> ${volumeIn3_piece.toFixed(4)} in¬≥</div>
      <div><b>Peso (por pieza, factor fijo ${FACTOR_IN3_TO_KG}):</b> ${weightKg_piece.toFixed(3)} kg</div>

      <div class="hr"></div>

      <div><b>Material:</b> ${money(material_total)} <span class="muted">( ${money(material_piece)} c/u )</span></div>
      <div><b>L√°ser:</b> ${money(laser_total)} <span class="muted">(${cutMin_total.toFixed(2)} min total √ó ${money(usdHr)}/h)</span></div>
      <div><b>Setup (lote):</b> ${money(setup)}</div>

      <div class="hr"></div>

      <div><b>Costo base:</b> ${money(base_total)}</div>
      <div><b>Merma:</b> ${(wastePct*100).toFixed(0)}%</div>
      <div><b>Margen:</b> ${(marginPct*100).toFixed(0)}%</div>

      ${notes ? `<div class="hr"></div><div><b>Notas:</b> ${escapeHtml(notes)}</div>` : ""}
    `;

    document.getElementById("copyStatus").textContent = "";
  }

  function escapeHtml(s){
    return s.replaceAll("&","&amp;").replaceAll("<","&lt;").replaceAll(">","&gt;")
            .replaceAll('"',"&quot;").replaceAll("'","&#039;");
  }

  function whatsappText(){
    if (!LAST) return "Cotizaci√≥n (sin datos).";
    const I = LAST.inputs, C = LAST.calc;

    const tm = (I.timeMode === "per_piece")
      ? `Tiempo por pieza: ${I.cutMinInput} min ${I.cutSecInput} seg`
      : `Tiempo total del lote: ${I.cutMinInput} min ${I.cutSecInput} seg`;

    return [
      "üìå *Cotizaci√≥n Corte L√°ser (Acero)*",
      `‚Ä¢ Piezas: ${I.qty}`,
      `‚Ä¢ Medidas: ${I.L}" √ó ${I.W}" √ó ${I.T}"`,
      `‚Ä¢ ${tm}`,
      `‚Ä¢ Tiempo total: ${C.cutMin_total.toFixed(2)} min`,
      "",
      `üíµ *Total:* ${money(C.total)}`,
      `üíµ *Precio c/u:* ${money(C.per_piece)}`,
      "",
      "Detalle:",
      `‚Ä¢ Material: ${money(C.material_total)} (${money(C.material_piece)} c/u)`,
      `‚Ä¢ L√°ser: ${money(C.laser_total)} (${C.cutMin_total.toFixed(2)} min total a ${money(I.usdHr)}/h)`,
      `‚Ä¢ Setup: ${money(I.setup)}`,
      "",
      `Volumen/pza: ${C.volumeIn3_piece.toFixed(4)} in¬≥ | Peso/pza: ${C.weightKg_piece.toFixed(3)} kg`,
      `Factor fijo: ${FACTOR_IN3_TO_KG} (in¬≥‚Üíkg) | USD/kg: ${I.usdKg} | Merma: ${(I.wastePct*100).toFixed(0)}% | Margen: ${(I.marginPct*100).toFixed(0)}%`,
      I.notes ? `Notas: ${I.notes}` : ""
    ].filter(Boolean).join("\n");
  }

  async function copyWhatsApp(){
    calc();
    const text = whatsappText();
    try{
      await navigator.clipboard.writeText(text);
      document.getElementById("copyStatus").textContent = "‚úÖ Copiado. P√©galo en WhatsApp.";
    } catch(e){
      const ta = document.createElement("textarea");
      ta.value = text;
      document.body.appendChild(ta);
      ta.select();
      document.execCommand("copy");
      document.body.removeChild(ta);
      document.getElementById("copyStatus").textContent = "‚úÖ Copiado (modo compatibilidad).";
    }
  }

  function shareWhatsApp(){
    calc();
    const text = encodeURIComponent(whatsappText());
    window.open(`https://wa.me/?text=${text}`, "_blank");
  }

  function printPDF(){
    calc();
    window.print();
  }

  function loadHistory(){
    try{
      const raw = localStorage.getItem(HISTORY_KEY);
      const arr = raw ? JSON.parse(raw) : [];
      return Array.isArray(arr) ? arr : [];
    } catch { return []; }
  }

  function saveHistory(arr){
    localStorage.setItem(HISTORY_KEY, JSON.stringify(arr));
  }

  function saveToHistory(){
    calc();
    if (!LAST) return;

    const hist = loadHistory();
    hist.unshift(LAST);

    const trimmed = hist.slice(0, 50);
    saveHistory(trimmed);
    renderHistory();
    document.getElementById("copyStatus").textContent = "‚úÖ Guardado en historial.";
  }

  function clearHistory(){
    if (!confirm("¬øSeguro que quieres borrar TODO el historial?")) return;
    localStorage.removeItem(HISTORY_KEY);
    renderHistory();
  }

  function deleteHistoryItem(ts){
    const hist = loadHistory().filter(x => x?.ts !== ts);
    saveHistory(hist);
    renderHistory();
  }

  function loadFromHistory(ts){
    const hist = loadHistory();
    const item = hist.find(x => x?.ts === ts);
    if (!item) return;

    const I = item.inputs;
    document.getElementById("L").value = I.L;
    document.getElementById("W").value = I.W;
    document.getElementById("T").value = I.T;
    document.getElementById("qty").value = I.qty;
    document.getElementById("timeMode").value = I.timeMode;

    document.getElementById("cutMin").value = I.cutMinInput;
    document.getElementById("cutSec").value = I.cutSecInput ?? 0;

    document.getElementById("usdKg").value = I.usdKg;
    document.getElementById("usdHr").value = I.usdHr;
    document.getElementById("setup").value = I.setup;
    document.getElementById("wastePct").value = (I.wastePct * 100).toFixed(0);
    document.getElementById("marginPct").value = (I.marginPct * 100).toFixed(0);
    document.getElementById("notes").value = I.notes || "";

    document.getElementById("gaugeSelect").value = "";
    document.getElementById("fracSelect").value = "";

    calc();
    document.getElementById("copyStatus").textContent = "‚úÖ Cargado desde historial.";
    window.scrollTo({ top: 0, behavior: "smooth" });
  }

  function renderHistory(){
    const box = document.getElementById("history");
    const hist = loadHistory();

    if (hist.length === 0){
      box.innerHTML = `<div class="muted" style="margin-top:10px;">No hay cotizaciones guardadas todav√≠a.</div>`;
      return;
    }

    box.innerHTML = hist.map(item => {
      const I = item.inputs, C = item.calc;
      const title = `${I.qty} pzs | ${I.L}√ó${I.W}√ó${I.T} in`;
      const sub = (I.timeMode === "per_piece")
        ? `${I.cutMinInput}m ${I.cutSecInput}s/pza ‚Üí ${C.cutMin_total.toFixed(1)} min total`
        : `${I.cutMinInput}m ${I.cutSecInput}s total`;

      return `
        <div class="historyRow">
          <div class="historyMain">
            <div style="font-weight:700;">${escapeHtml(title)}</div>
            <div class="muted">${escapeHtml(sub)} ‚Ä¢ ${escapeHtml(niceDate(item.ts))}</div>

            <div style="margin-top:6px;">
              <span class="pill">Total: ${money(C.total)}</span>
              <span class="pill">c/u: ${money(C.per_piece)}</span>
              <span class="pill">L√°ser: ${money(C.laser_total)}</span>
              <span class="pill">Material: ${money(C.material_total)}</span>
            </div>

            ${I.notes ? `<div class="muted" style="margin-top:8px;">Notas: ${escapeHtml(I.notes)}</div>` : ""}
          </div>

          <div class="smallBtns">
            <button class="primary" onclick="loadFromHistory('${item.ts}')">Cargar</button>
            <button class="ghost" onclick="copyFromHistory('${item.ts}')">Copiar</button>
            <button class="danger" onclick="deleteHistoryItem('${item.ts}')">Borrar</button>
          </div>
        </div>
      `;
    }).join("");
  }

  async function copyFromHistory(ts){
    const hist = loadHistory();
    const item = hist.find(x => x?.ts === ts);
    if (!item) return;

    const prev = LAST;
    LAST = item;

    const text = whatsappText();
    try{
      await navigator.clipboard.writeText(text);
      document.getElementById("copyStatus").textContent = "‚úÖ Copiado desde historial.";
    } catch(e){
      const ta = document.createElement("textarea");
      ta.value = text;
      document.body.appendChild(ta);
      ta.select();
      document.execCommand("copy");
      document.body.removeChild(ta);
      document.getElementById("copyStatus").textContent = "‚úÖ Copiado (modo compatibilidad).";
    } finally {
      LAST = prev;
    }
  }

  function resetDefaults(){
    document.getElementById("L").value = 6;
    document.getElementById("W").value = 3;
    document.getElementById("T").value = 0.0625;
    document.getElementById("qty").value = 1;
    document.getElementById("timeMode").value = "per_piece";
    document.getElementById("cutMin").value = 15;
    document.getElementById("cutSec").value = 0;
    document.getElementById("gaugeSelect").value = "";
    document.getElementById("fracSelect").value = "";
    document.getElementById("usdKg").value = 1.7;
    document.getElementById("usdHr").value = 85;
    document.getElementById("setup").value = 0;
    document.getElementById("wastePct").value = 0;
    document.getElementById("marginPct").value = 0;
    document.getElementById("notes").value = "";
    calc();
  }

  window.addEventListener("load", () => {
    initLists();
    calc();
    renderHistory();
  });
</script>
</body>
</html>
